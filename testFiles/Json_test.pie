// ============================================
// PIE JSON MODULE REGRESSION TEST
// ============================================
// Validates: creation, access, mutation, nesting,
// parsing, stringification, and error handling.
//
// Author: Ian
// Target: PIE 1.0.0 JSON module
// ============================================

import json;

// Utility: Pretty output separator
void section(string title) {
    output("\n\n=============================", string);
    output(title, string);
    output("=============================\n", string);
}

// Utility: Print JSON
void printJson(ptr obj) {
    output(json.stringify(obj), string);
}

// ============================================
// SECTION 1: Basic Object Creation and Access
// ============================================

section("1. Basic Object Creation and Access");

ptr user = json.create_object();
json.set_string(user, "name", "Ian");
json.set_int(user, "age", 22);

string name = json.get_string(user, "name");
int age = json.get_int(user, "age");
output("User: "+name+" is "+age+" years old", string);

json.set_int(user, "age", 23);
output("After birthday: "+json.stringify(user), string);

// ============================================
// SECTION 2: Arrays of Primitives
// ============================================

section("2. Arrays of Primitives");

ptr scores = json.create_array();
json.array_push_int(scores, 90);
json.array_push_int(scores, 80);
json.array_push_int(scores, 100);

output("Scores: "+json.stringify(scores), string);
output("First score: "+json.array_get_int(scores, 0), string);
output("Total scores: "+json.array_size(scores), string);

// ============================================
// SECTION 3: Array of Objects
// ============================================

section("3. Arrays of Objects");

ptr users = json.create_array();

ptr user1 = json.create_object();
json.set_string(user1, "name", "Alice");
json.set_int(user1, "age", 25);
json.array_push_object(users, user1);

ptr user2 = json.create_object();
json.set_string(user2, "name", "Bob");
json.set_int(user2, "age", 30);
json.array_push_object(users, user2);

output("Array of users: "+json.stringify(users), string);

ptr u0 = json.array_get_object(users, 0);
output("First user: "+json.get_string(u0, "name"), string);

// ============================================
// SECTION 4: Nested Object Containing Array of Objects
// ============================================

section("4. Nested Object Containing Array of Objects");

ptr response = json.create_object();
json.set_string(response, "status", "success");
ptr users2 = json.create_array();

ptr userA = json.create_object();
json.set_string(userA, "username", "PieDev");
json.set_string(userA, "role", "admin");
json.array_push_object(users2, userA);

ptr userB = json.create_object();
json.set_string(userB, "username", "Guest");
json.set_string(userB, "role", "viewer");
json.array_push_object(users2, userB);

json.set_array(response, "data", users2);
output("Complex response: "+json.stringify(response), string);

ptr data = json.get_array(response, "data");
ptr firstUser = json.array_get_object(data, 0);
output("First user is "+json.get_string(firstUser, "username"), string);

// ============================================
// SECTION 5: Object in Object in Array
// ============================================

section("5. Object in Object in Array");

ptr network = json.create_object();
ptr nodes = json.create_array();

ptr node1 = json.create_object();
json.set_string(node1, "id", "A");

ptr connection = json.create_object();
json.set_string(connection, "target", "B");
json.set_int(connection, "weight", 5);

json.set_object(node1, "connection", connection);
json.array_push_object(nodes, node1);
json.set_array(network, "nodes", nodes);

output("Network structure: "+json.stringify(network), string);
ptr nodesArray = json.get_array(network, "nodes");
ptr firstNode = json.array_get_object(nodesArray, 0);
ptr conn = json.get_object(firstNode, "connection");
output("First node connects to "+json.get_string(conn, "target"), string);

// ============================================
// SECTION 6: Deeply Nested Structure
// ============================================

section("6. Deeply Nested Structure");

ptr root = json.create_object();
ptr level1 = json.create_object();
ptr level2 = json.create_object();
ptr level3 = json.create_object();

json.set_string(level3, "final_value", "Deep!");
json.set_object(level2, "level3", level3);
json.set_object(level1, "level2", level2);
json.set_object(root, "level1", level1);

output("Deep nested object: "+json.stringify(root), string);
ptr l1 = json.get_object(root, "level1");
ptr l2 = json.get_object(l1, "level2");
ptr l3 = json.get_object(l2, "level3");
output("Accessed deep value: "+json.get_string(l3, "final_value"), string);

// ============================================
// SECTION 7: Array in Object in Array in Object
// ============================================

section("7. Array in Object in Array in Object");

ptr catalog = json.create_object();
ptr products = json.create_array();
ptr product1 = json.create_object();
json.set_string(product1, "name", "Laptop");
ptr reviews = json.create_array();
ptr review1 = json.create_object();
json.set_string(review1, "user", "TechGuru");
json.set_int(review1, "rating", 5);
json.array_push_object(reviews, review1);
json.set_array(product1, "reviews", reviews);
json.array_push_object(products, product1);
json.set_array(catalog, "products", products);

output("Catalog: "+json.stringify(catalog), string);
ptr prods = json.get_array(catalog, "products");
ptr firstProd = json.array_get_object(prods, 0);
ptr revs = json.get_array(firstProd, "reviews");
ptr firstRev = json.array_get_object(revs, 0);
output("First review by "+json.get_string(firstRev, "user"), string);

// ============================================
// SECTION 8: Arrays of Mixed Nested Objects
// ============================================

section("8. Arrays of Mixed Nested Objects");

ptr post = json.create_object();
json.set_string(post, "author", "Ian");
json.set_string(post, "title", "Testing PIE JSON");
json.set_string(post, "content", "Exploring nested JSON handling in PIE");

ptr comments = json.create_array();
ptr c1 = json.create_object();
json.set_string(c1, "user", "Alice");
json.set_string(c1, "message", "Great work!");
json.array_push_object(comments, c1);

ptr c2 = json.create_object();
json.set_string(c2, "user", "Bob");
json.set_string(c2, "message", "This looks powerful.");
json.array_push_object(comments, c2);

json.set_array(post, "comments", comments);
output("Post with comments: "+json.stringify(post), string);

ptr comms = json.get_array(post, "comments");
int commCount = json.array_size(comms);
output("Total comments: "+commCount, string);
for(int i=0; i<commCount; i++){
    ptr com = json.array_get_object(comms, i);
    output("Comment by "+json.get_string(com, "user")+": "+json.get_string(com, "message"), string);
}

// ============================================
// SECTION 9: Parsing and Round-Trip Tests
// ============================================

section("9. Parsing and Round-Trip Tests");

ptr company = json.create_object();
ptr employees = json.create_array();
ptr emp1 = json.create_object();
json.set_string(emp1, "name", "John");
json.set_string(emp1, "role", "developer");
ptr skills1 = json.create_array();
json.array_push_string(skills1, "Python");
json.array_push_string(skills1, "JavaScript");
json.set_array(emp1, "skills", skills1);
json.array_push_object(employees, emp1);

ptr emp2 = json.create_object();
json.set_string(emp2, "name", "Jane");
json.set_string(emp2, "role", "designer");
ptr skills2 = json.create_array();
json.array_push_string(skills2, "Photoshop");
json.array_push_string(skills2, "Illustrator");
json.set_array(emp2, "skills", skills2);
json.array_push_object(employees, emp2);

json.set_array(company, "employees", employees);

output("Built company: "+json.stringify(company), string);
string serialized = json.stringify(company);
ptr reparsed = json.parse(serialized);
output("Round-trip result: "+json.stringify(reparsed), string);

// ============================================
// SECTION 10: Error & Stress Tests
// ============================================

section("10. Error & Stress Tests");

// Invalid JSON Parsing
string badJson = "{ 'name': 'Ian' ";
ptr bad = json.parse(badJson);
if(bad == null){
    output("Invalid JSON correctly failed to parse.", string);
}else{
    output("Unexpected success parsing invalid JSON.", string);
}

// Mixed-type access
int invalidAccess = json.get_int(user, "name");  // should be default 0
output("Invalid type access returned: "+invalidAccess, string);

// Large array stress test
ptr bigArr = json.create_array();
for(int i=0; i<1000; i++){
    json.array_push_int(bigArr, i);
}
output("Large array size: "+json.array_size(bigArr), string);

// Repeated stringify test
for(int j=0; j<100; j++){
    string s = json.stringify(company);
}
output("Repeated stringify test completed.", string);

// Mutability test
ptr parsed = json.parse(serialized);
ptr empArr = json.get_array(parsed, "employees");
ptr first = json.array_get_object(empArr, 0);
json.set_string(first, "name", "Modified");
output("After mutation: "+json.stringify(parsed), string);

output("\nAll tests completed successfully!", string);
